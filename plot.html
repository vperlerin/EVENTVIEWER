<!DOCTYPE html>
<html>
   <head>
      <meta charset="utf-8" />
      <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
      <title>AllSkycams Event Plots Viewer</title>  
      <style>*,body{color:#000;text-align: center}.svg-container{margin:0 auto!important;}</style>
   </head>
   <body style="margin:0; padding:0;">
   <script src="/dist/js/allsky_eventviewer.min.js"></script>
   <script>

      /************ GRAPHICS STYLES ********************/
      var PLOT_W = 937;
      var PLOT_H = 517;
      var GRID_COLOR = 'rgba(255,255,255,.2)';
      var TICK_FONT_COLOR = 'rgba(255,255,255,.35)';
      var H_LINE_COLOR = 'rgba(255,255,255,.4)';
      var V_LINE_COLOR = 'rgba(255,255,255,.5)';
      var FONT_COLOR = '#ffffff';
      var AXIS_FONT_COLOR = '#b1b1b1';
   

      var PAPER_BG_COLOR = 'rgba(9,29,63,1)';
      var PLOT_BG_COLOR = PAPER_BG_COLOR;
      var TRENDLINE_COLOR = 'rgba(213,42,224,.5)';
      var DEFAULT_LINE_COLOR = 'rgba(213,42,224,.5)';

      // LEGEND
         
      var LEGEND_FONT_COLOR = FONT_COLOR;
      var LEGEND_BORDER = 'rgba(255,255,255,.0)';
      var LEGEND_BG = 'rgba(255,255,255,.01)';

      // GEO
      var RIVER_COLOR = "#c8eaff";
      var LAND_COLOR = "#d4ffae";
      var SUB_UNIT_BORDER = "#ccc";
 

      var XY_SERIES_MAX = 3;
 
      /*******************************/
      var graph_counter = 0;


      /*********** UI ***************************/
      // Hide legend on hover (if data is behind)
      function hide_legend_on_hover() {
         $('.svg-container').hover(function() {
            $(this).find('.legend').fadeOut();
         }).mouseout(function() {
            $(this).find('.legend').fadeIn();
         });
      }

 
      /*********** PARSE URL ***************************/

      // URL PARAM:
      // j= json with plots
      // t= which plots we want to display

      // Print error
      function print_error(txt) {
         $('<div class="alert alert-danger">'+txt+'</div>').appendTo($('body'));
      }
      
      // Read URL PARAMS
      function urlParams() {
         location.queryString = {};
         location.search.substr(1).split("&").forEach(function (pair) {
            if (pair === "") return;
            var parts = pair.split("=");
            location.queryString[parts[0]] = parts[1] && decodeURIComponent(parts[1].replace(/\+/g, " "));
         });
         return location.queryString;
      } 
      
      // Get URL PARAMS AND PARSE JSON
      function get_json() {
         var all_params = urlParams(); 
         if(typeof all_params['j'] !== 'undefined' && typeof all_params['t'] !== 'undefined') {
            parseJsonPlot(all_params['j'],all_params['t']);
         } else if(typeof all_params['j'] !== 'undefined'){
           // We create all the plots at once
           parseJsonPlot(all_params['j'],'all');
         } else {
            print_error('t parameter (plot type) is missing in URL')
         }
      }

      
 
      // PARSE JSON
      function parseJsonPlot(json_file,plot_ids) {

        var r_plot_id = plot_ids.split(",");
        
         $.ajax({
            url :json_file, 
            dataType : 'json',
            success : function(json_code, status){ // success est toujours en place, bien sÃ»r !
               var f = false;


               if(typeof json_code['plots'] !== "undefined") { 


                  if(plot_ids == 'all') {
                     r_plot_id = []
                     $.each(json_code['plots'], function(i,v) { 
                        r_plot_id.push(v.plot_id);
                     });
                  }
                  
                  // We search the proper plots
                  $.each(json_code['plots'], function(i,v) { 
                     if(r_plot_id.indexOf(v['plot_id']) > -1)  {
                        // We Draw the corresponding plot 
                        draw_plot(v,r_plot_id[r_plot_id.indexOf(v['plot_id'])],r_plot_id.indexOf(v['plot_id']));
                        f= true;
                     }
                  })
                
                

                  // Setup UI
                  hide_legend_on_hover();

                  // Change Body bg color
                  $('body').css('background-color',PAPER_BG_COLOR);

                  if(!f) {
                     print_error('Plot type <b>' + plot_ids + '</b> not found')
                  }

               } else {
                  print_error('Plots not found in ' + json_file)
               }
            },

            error : function(res, status, error){
               print_error('Impossible to parse the file ' + json_file + "<br>" + error)
            }

         });
 
      }


      /*********** DRAW PLOT ***************************/
      // HEx to RGBA 
      function hexToRgb(hex) {
         var bigint = parseInt(hex, 16);
         var r = (bigint >> 16) & 255;
         var g = (bigint >> 8) & 255;
         var b = bigint & 255;
         return r + "," + g + "," + b + ",1";
      } 
 
      function create_rainbow_colors() {
         // Create Colors
         var rainbow = new Rainbow();
         rainbow.setNumberRange(0, 255);
         return rainbow;
      }
      

      // Add rainbdow colors to array
      function  get_rainbow_colors(total,rainbowcolors) {
         var all_colors = [];
         if(total>=255) {   
            // Default color for the end...
            for (var i = 255; i <= total; i = i + step) {
               all_colors[i] = '#0000ff';
            }
            for (var i = 0; i <= 255; i = i + step) {
               all_colors[i] = '#'+rainbowcolors.colourAt(i);
            }
         } else {
            step = parseInt(255/total);  

            for (var i = 0; i <= 255; i = i + step) {
               all_colors.push('rgba('+hexToRgb(rainbowcolors.colourAt(i))+')');
            }
         }
         return all_colors;
      }
   
 
      // Set Generic LAYOUT options
      function set_generic_layout_options(layout) {
         layout.title =    { 
                  font: {  color: FONT_COLOR },
                  xref: 'x',   
                  yref: 'y',  
                  x: 0.05, 
         } ;
         layout.height = PLOT_H;
         layout.width =  PLOT_W;
         layout.paper_bgcolor =  PAPER_BG_COLOR;   
         layout.plot_bgcolor = PLOT_BG_COLOR; 

         layout.xaxis =  { 
            zerolinecolor: H_LINE_COLOR, 
            zerolinewidth: 1,
            gridcolor: GRID_COLOR, 
            linecolor: H_LINE_COLOR,  
            title: { font: { size: 15, color: AXIS_FONT_COLOR } },
            tickfont: { color: TICK_FONT_COLOR},
         };

         layout.yaxis =  {
            zerolinecolor: V_LINE_COLOR, 
            zerolinewidth: 1, 
            gridcolor: GRID_COLOR, 
            linecolor: V_LINE_COLOR,
            title: { font: {  size: 15, color:  AXIS_FONT_COLOR}}, 
            tickfont: { color: TICK_FONT_COLOR},
         };

         layout.showlegend = true;
         layout.legend = {
               xanchor:"right",
               yanchor:"bottom",
               y:5,  
               x:1,
               orientation: 'v',
               traceorder: 'normal',
               bordercolor: LEGEND_BORDER,  
               borderwidth: 1,
               bgcolor:  LEGEND_BG,
               font: {
                  color: LEGEND_FONT_COLOR
               } 
         };

         return layout
      }

      // Set Layout for 2D Maps
      function set_2Dmap_layout(layout,avg_lat,avg_lon) {
         layout.geo =    { 
            resolution: 50,
            showland: true,
            showlakes: false,
            showrivers: false,  
            showcountries: true,  
            showsubunits: true,
            subunitwidth:1,
            subunitcolor:SUB_UNIT_BORDER,
            landcolor: LAND_COLOR,  
            countrywidth: 1.5, 
            coastlinewidth: .5,
            width: PLOT_W,
            height: PLOT_H,
            lataxis: {
               showgrid: true,
               tickmode: 'linear',
               range: [ avg_lat-2, avg_lat+2 ],
               dtick: 5 
            },
            lonaxis:{
               showgrid: true,
               tickmode: 'linear',
               range: [avg_lon-5, avg_lon+5],
               dtick: 5 
            }
          }
         return layout
      }
      
      

      function set_new_graph_container() {
         var graph_name = "graph_"+ graph_counter;
         $('<div id="'+graph_name+'"></div>').appendTo($('body'));   
         graph_counter++;
         return graph_name;
      }


      // Draw default x,y plot
      function draw_plot_xy(data) {

         // Create Default Layout
         var layout = {};
         layout = set_generic_layout_options(layout);
          
         // Speficics for xy
         layout.title.x = 0.05;
         layout.xaxis.side = 'bottom';
         
         // Plot Name
         layout.title.text =  typeof data.plot_name !== 'undefined'?data.plot_name:'';   

         if(typeof data.plot_y_axis_reverse !== "undefined") {
            if(data.plot_y_axis_reverse == 1) {
                  layout.yaxis.autorange = "reversed" 
            }
         }  

         // Add labels
         if(typeof data.x_label !== "undefined") {
            layout.xaxis.title.text = data.x_label; 
         }
         if(typeof data.y_label !== "undefined") {
            layout.yaxis.title.text = data.y_label; 
         }

         // make traces data array for each data series
         traces = [];
         ti = 0;  // Trace Counter

         for (i = 1; i <= XY_SERIES_MAX; i++) {
            
            // The values
            field_x           = "x" + i + "_vals";
            field_y           = "y" + i + "_vals";
            field_line_on     = "x" + i + "_line";
            data_label        = "x" + i + "_data_label";
            data_marker       = "x" + i + "_symbol;"
            data_marker_size  = "x" + i + "_symbol_size";
            data_marker_color = "x" + i + "_color";
 
            if(typeof data[field_x] !== 'undefined' && typeof data[field_y] !== 'undefined') {
              
               traces[ti] = {
                  x: data[field_x],
                  y: data[field_y],
                  mode: 'markers',
                  marker: {  symbol: (data[data_marker]?data[data_marker]:'cross'), 
                             size: (data[data_marker_size]?data[data_marker_size]:5), 
                             type: 'scatter'
                  },
                  name: (data[data_label]?data[data_label]:'') 
               };

               // Colors
               if(data[data_marker_color]) {
                  traces[ti].marker.color = data[data_marker_color]; 
               }

               // Markers size
               if(data[data_marker_size]) {
                  traces[ti].marker.size = data[data_marker_size]; 
               }

               // Line
               if(typeof data[field_line] !== 'undefined') {
                  if(data[field_line] == "1") {
                     traces[ti].mode="lines+markers";
                  }
               }

               ti++;
            }
         } 
 
         // make the trend line if tx1_vals exist
         if(typeof data['tx1_vals'] !== 'undefined' && typeof ["ty1_vals"] !== 'undefined') {
            traces[ti] = {
               x: data["tx1_vals"],
               y: data["ty1_vals"],
               mode: 'lines',
               name: typeof data['tx1_data_label']!== "undefined"?data['tx1_data_label']:'',
               type: 'line',
               line: {
                  width: 1,
                  color: typeof data['tx1_line_color']!== "undefined"?data['tx1_line_color']:DEFAULT_LINE_COLOR
               }
            }
         }
             
         Plotly.newPlot( set_new_graph_container(), traces,layout);
     
      }


 
   // Draw 2D plot map
   function draw_plot_map(data) {
      // Station colors
      var colors = get_rainbow_colors(data['points'].length+1,create_rainbow_colors())
       
      map_data = []
      lats = []
      lons = []
      names= []
      traces = [] 
      // MAKE POINTS FROM DATA 
      for (var i = 0; i < data['points'].length; i++) {
 
         tlat = parseFloat(data['points'][i][0])
         tlon = parseFloat(data['points'][i][1]) 
   
         trace =  {
            type: 'scattergeo',
            mode: 'markers+text' ,
            lon: [tlon],
            lat: [tlat],
            marker: {
               size: 10,
               color: colors[i],
               line : {
                  width: 2
               }
            },
            text:  [data['point_names'][i]],
            textposition: ["top center"],
            name: data['point_names'][i]
         } 
         lats.push(tlat) 
         lons.push(tlon)  
         traces.push(trace) 
      }
  
   
      // MAKE LINES FROM DATA 
      $.each( data['lines'], function(i,line) {
         traces.push( {
            type: 'scattergeo',
            mode: 'lines' ,
            lon: [parseFloat(line[1]), parseFloat(line[3])],
            lat: [parseFloat(line[0]), parseFloat(line[2])],
            marker: { 
               color: DEFAULT_LINE_COLOR,
               line : {   width: 1  }
            },
            name: "Meteor" 
         });

         lats.push(parseFloat(line[0]));
         lats.push(parseFloat(line[2]));
         lons.push(parseFloat(line[1]));
         lons.push(parseFloat(line[3]));
      });
      
      sum_lat = lats.reduce((a,b) => a+b,0);
      avg_lat = (sum_lat/lats.length) || 0;
      sum_lon = lons.reduce((a,b) => a+b,0);
      avg_lon = (sum_lon/lons.length) || 0; 

      // Create Default Layout
      var layout = {};
      layout = set_generic_layout_options(layout);
      layout = set_2Dmap_layout(layout,avg_lat,avg_lon);

      // Add the map scope if any
      if(typeof data['scope'] !== 'undefined') {
         layout.geo.scope = data['scope'];
      }
      

      // Set Title
      layout.title.text = (typeof data['plot_name'] !== "undefined")?data['plot_name'] :""
      
      // DRAW
      Plotly.newPlot( set_new_graph_container(), traces,layout);
}

      
   // Main function to draw all plots
   function draw_plot(data,plot_id, order) {

      switch(plot_id) {
         case "iorbit":
            // Orbit Viewer
            //window.location = data['plot_url'];
            break;
         case "3D_traj":
            draw_plot_map_3D(data);
            break;
         case "ground_track":
            draw_plot_map(data);
            break;
         default:
            draw_plot_xy(data);
      } 
   }


   $(function() {
      get_json();
   });

    

   function draw_plot_map_3D(data) {
      colors = ['orange', 'blue', 'green', 'purple', 'pink', 'white']
      traces = []
      // MAKE POINTS FROM DATA
      cc = 0
      all_lats = []
      all_lons = []
      for (var i = 0; i < data['points'].length; i++) {

         if (cc >= colors.length) {
            cc = 0
         }
         tlat = parseFloat(data['points'][i][0])
         tlon = parseFloat(data['points'][i][1])
         all_lats.push(tlat)
         all_lons.push(tlon)
         name = data['point_names'][i]
         trace =  {
            type: 'scatter3d',
            mode: 'markers' ,
            x: [tlon],
            y: [tlat],
            z: [0],
            marker: {
               size: 7,
               color: colors[cc],
               line : {
                  width: 1
               }
            },
            name: name
         }
         traces.push(trace)
         cc++
      }
      // MAKE LINES FROM DATA
      cc = 0
      for (var i = 0; i < data['lines'].length; i++) {

         if (cc >= colors.length) {
            cc = 0
         }
         slat = parseFloat(data['lines'][i][0])
         slon = parseFloat(data['lines'][i][1])
         salt = parseFloat(data['lines'][i][2])
         elat = parseFloat(data['lines'][i][3])
         elon = parseFloat(data['lines'][i][4])
         ealt = parseFloat(data['lines'][i][5])
         all_lats.push(slat)
         all_lons.push(slon)
         all_lats.push(elat)
         all_lons.push(elon)
         name = data['point_names'][i]
         trace =  {
            type: 'scatter3d',
            mode: 'lines' ,
            x: [slon,elon],
            y: [slat,elat],
            z: [salt,ealt],
            marker: {
               size: 7,
               color: data['line_colors'][i],
               line : {
                  width: 1
               }
            },
            name: data['line_names'][i]
         }
         traces.push(trace)
         cc++
      }
      // get min/max range for x,y axis
      max_lat = Math.max.apply(null,all_lats) 
      min_lat = Math.min.apply(null,all_lats) 
      max_lon = Math.max.apply(null,all_lons) 
      min_lon = Math.min.apply(null,all_lons) 
      rlon1 = min_lon - 1
      rlon2 = max_lon + 1
         var layout = {
            title: {
               font: {  color: FONT_COLOR },
               xref: 'x',
               yref: 'y',
               x: 0.05,
            },
            height: PLOT_H,
            width: PLOT_W,
            paper_bgcolor: PAPER_BG_COLOR,
            xaxis:{
                  zerolinecolor: H_LINE_COLOR,
                  zerolinewidth: 1,
                  gridcolor: GRID_COLOR,
                  linecolor: H_LINE_COLOR,
                  title: { font: { size: 15, color: AXIS_FONT_COLOR } },
                  tickfont: { color: TICK_FONT_COLOR},
                  side:'bottom'
            },
            yaxis:{
                  range : [rlon1, rlon2],
                  zerolinecolor: V_LINE_COLOR,
                  zerolinewidth: 1,
                  gridcolor: GRID_COLOR,
                  linecolor: V_LINE_COLOR,
                  title: { font: {  size: 15, color:  AXIS_FONT_COLOR}},
                  tickfont: { color: TICK_FONT_COLOR},
                  
            },
            zaxis:{
                  range : [0, 100],
                  zerolinecolor: V_LINE_COLOR,
                  zerolinewidth: 1,
                  gridcolor: GRID_COLOR,
                  linecolor: V_LINE_COLOR,
                  title: { font: {  size: 15, color:  AXIS_FONT_COLOR}},
                  tickfont: { color: TICK_FONT_COLOR},
            },
            showlegend: true,
	    scene: {
		xaxis:{title: 'Longitude'},
		yaxis:{title: 'Latitude'},
		zaxis:{title: 'Altitude'},
            },
            margin: {
             l: 50,
             r: 50,
             t: 50,
             b: 50
            },
            legend: {
               traceorder: 'normal',
               font: {
               color: LEGEND_FONT_COLOR
               }
            }
         };

      Plotly.newPlot('mydiv', traces,layout);

   }
 

   </script>

   <div id="mydiv"></div>
   </body>
</html>
